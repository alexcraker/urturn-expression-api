var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),n="x"==t?e:8|3&e;return n.toString(16)})},UT.UUID=UT.uuid;var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{get:e,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{set:e,enumerable:!0,configurable:!0})}}))}catch(t){throw Error("Simple Storage API not Supported")}};supportGetSet(),UT.Collection=function(t){this.length=0,this.name=null,this.setUserItem=function(t){if(!r)throw o.authenticate(),Error("ArgumentError","No currentUserId defined");return this.setItem(r,t)},this.getUserItem=function(){return r?this.getItem(r):void 0};var e=function(t,e){if(!t)throw Error("InvalidKey",t);if(-1!=d.indexOf(t))throw Error("ReservedKey",t);var n=g(t,e),i=this.getItem(t);return n||s[t]?(v(i,n),!i||null!==n&&void 0!==n?!i&&n?(f++,l.push(t),s[t]=n):s[t]=n:(l.splice(l.indexOf(t),1),f--,delete s[t]),-1==u.indexOf(t)&&u.push(t),this.length=l.length,e):n};this.setItem=e;var n=function(t,e){if(!t)return null;var n=s[t];return void 0===n?-1===h.indexOf(t)&&void 0!==this[t]?this[t]:e:"literal"==n._type?n.value:n};this.getItem=n,this.key=function(t){return t>=l.length?null:l[t]},this.average=function(t){return c[t]?c[t].average:void 0},this.sum=function(t){return c[t]?c[t].sum:void 0},this.count=function(t){if(!t)return f;if(c[t])return c[t]?c[t].count:void 0},this.toString=function(){return'<Collection @name="'+this.name+'">'};var i=function(t){return t&&t.marshall?t.marshall():t?t:null};this.save=function(){x.apply(this);var t={};if(u.length>0){for(var e=0;u.length>e;e++)t[u[e]]=i(s[u[e]]);o.save(this.name,t),u=[]}},this.getCurrentData=function(){var t={name:this.name,count:f,definition:a.definition,operations:[],items:[]};if(a.operations)for(var e=0;a.operations.length>e;e++){var n={operation:a.operations[e].operation,field:a.operations[e].field};p[n.operation].toJsonData(c[n.field],n),t.operations.push(n)}for(var i in s){var r=s[i];r._key=i,t.items.push(r)}return t},this.refresh=function(t){m.call(this,{currentUserId:r,delegate:o,data:t})};var r,o,a,s,c,l,u,h,f,d=["refresh","setItem","getItem","count","sum","key","getUserItem","setUserItem","average","toString","size","length","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],p={_transfer:function(t,e){for(var n=Array.prototype.slice.call(arguments,2),i=n.length-1;i>=0;i--)e[n[i]]=t[n[i]]},average:{fromJsonData:function(t,e){void 0===e.average||void 0===e.average_count?(t.average=-1,t.average_count=0):p._transfer(e,t,"average","average_count")},toJsonData:function(t,e){p._transfer(t,e,"average","average_count")},recompute:function(t,e,n,i){var r=t.average_count;n&&void 0!==n[e.field]&&(t.average=(t.average*r-n[e.field])/parseFloat(r-1),r--),i&&void 0!==i[e.field]&&(t.average=(t.average*r+i[e.field])/parseFloat(r+1),r++),t.average_count=r}},count:{fromJsonData:function(t,e){void 0===e.count?t.count=0:p._transfer(e,t,"count")},toJsonData:function(t,e){p._transfer(t,e,"count")},recompute:function(t,e,n,i){n&&n[e.field]&&void 0!==n[e.field]&&(t.count=t.count-1),i&&i[e.field]&&void 0!==i[e.field]&&t.count++}},sum:{fromJsonData:function(t,e){void 0===e.sum?t.sum=0:p._transfer(e,t,"sum")},toJsonData:function(t,e){p._transfer(t,e,"sum")},recompute:function(t,e,n,i){n&&n[e.field]&&void 0!==n[e.field]&&(t.sum=t.sum-n[e.field]),i&&i[e.field]&&void 0!==i[e.field]&&(t.sum=t.sum+i[e.field])}}},v=function(t,e){if(a.operations)for(var n=0;a.operations.length>n;n++){var i=a.operations[n];(e&&void 0!==e[i.field]||t&&void 0!==t[i.field])&&p[i.operation].recompute(c[i.field],i,t,e)}},g=function(t,e){if(void 0!==e&&null!==e){if(e&&e.marshall)return e._key=t,e;if("function"==typeof e)throw Error("ArgumentError cannot serialize function");("object"!=typeof e||[].constructor===e.constructor)&&(e={_type:"literal",value:e});var n,i={};if(a.definition&&(n=a.definition.fields)&&n.length>0){for(var r=!1,o=0;n.length>o;o++){var s=n[o];if(void 0!==e[s.name])if(r=!0,"string"==s.type)i[s.name]=e[s.name];else if("number"==s.type){var c=parseFloat(e[s.name]);if(isNaN(c)||!isFinite(e[s.name]))throw Error("TypeError","Wrong value for field note");i[s.name]=c}else{if("boolean"!=s.type)throw Error("TypeError","Unkown type "+s.type);i[s.name]=!!e[s.name]}}if(!r)throw Error("InvalidItemError no valid field specified")}else i=e;if(i._key=t,e.constructor!=={}.constructor)throw Error("Unserialisable object");return i}},m=function(t){if(!t.data)throw Error("ArgumentError","missing data");if(!t.data.name)throw Error("ArgumentError","no name in data");if(void 0===t.data.count)throw Error("ArgumentError","no count in data");if(c={},l=[],u=[],h=[],r=t.currentUserId,o=t.delegate,a=t.data,this.name=a.name,f=a.count,a.operations)for(var e=0;a.operations.length>e;e++){var n=a.operations[e];c[n.field]=c[n.field]||{},p[n.operation].fromJsonData(c[n.field],n)}y.call(this,a.items)},y=function(t){if(s={},t){for(var e=0;t.length>e;e++){var n=t[e],i=n._key;s[i]=n,E.call(this,i,n),l.push(i)}this.length=l.length}},E=function(t){-1==h.indexOf(t)&&-1==d.indexOf(t)&&(h.push(t),this.__defineGetter__(t,function(){return n.call(this,t)}),this.__defineSetter__(t,function(n){return e.call(this,t,n)}))},x=function(){for(var t=Object.keys(this),n=t.length-1;n>=0;n--){var i=t[n];-1==d.indexOf(i)&&-1==h.indexOf(i)&&(e.call(this,i,this[i]),E.call(this,i,this[i]))}};m.call(this,t)},UT.CollectionStore=function(t){this.data=t.data;var e=t.delegate;e.store=this;for(var n={},i=0;this.data.length>i;i++){var r=this.data[i],o=r.name;if(!o)throw Error("ArgumentError","data contains unamed collections.");n[o]=new UT.Collection({data:r,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e})}this.get=function(t){return n[t]},this.set=function(t){n[t.name]=t},this.each=function(t){for(var e in n)t(n[e])},this.flush=function(){e.flush()},this.getCurrentData=function(){r=[];for(var t in n)r.push(n[t].getCurrentData());return r},this.refresh=function(t,n){e.refreshCollections(t,n)}};