var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),i="x"==t?e:8|3&e;return i.toString(16)})},UT.UUID=UT.uuid,UT.Collection=function(t){this.length=0,this.name=null,this.setUserItem=function(t){if(!n)throw r.authenticate(),Error("ArgumentError","No currentUserId defined");return this.setItem(n,t)},this.getUserItem=function(){return n?this.getItem(n):void 0};var e=function(t,e){if(!t)throw Error("InvalidKey",t);if(-1!=f.indexOf(t))throw Error("ReservedKey",t);var i=v(t,e),n=null;return t&&(n=this.getItem(t)),p(n,i),!n||null!==i&&void 0!==i?!n&&i?(h++,c.push(t),a[t]=i):a[t]=i:(c.splice(c.indexOf(t),1),h--,delete a[t]),e&&(e._key=t),-1==l.indexOf(t)&&l.push(t),this.length=c.length,e};this.setItem=e;var i=function(t,e){if(!t)return null;var i=a[t];return void 0===i?-1===u.indexOf(t)&&void 0!==this[t]?this[t]:e:"literal"==i._type?i.value:i};this.getItem=i,this.key=function(t){return t>=c.length?null:c[t]},this.average=function(t){return s[t]?s[t].average:void 0},this.sum=function(t){return s[t]?s[t].sum:void 0},this.count=function(t){if(!t)return h;if(s[t])return s[t]?s[t].count:void 0},this.toString=function(){return'<Collection @name="'+this.name+'">'},this.save=function(){x.apply(this);var t={};if(l.length>0){for(var e=0;l.length>e;e++)t[l[e]]=a[l[e]].marshall();r.save(this.name,t),l=[]}},this.getCurrentData=function(){var t={name:this.name,count:h,definition:o.definition,operations:[],items:[]};if(o.operations)for(var e=0;o.operations.length>e;e++){var i={operation:o.operations[e].operation,field:o.operations[e].field};d[i.operation].toJsonData(s[i.field],i),t.operations.push(i)}for(var n in a){var r=a[n];r._key=n,t.items.push(r)}return t},this.refresh=function(t){m.call(this,{currentUserId:n,delegate:r,data:t})};var n,r,o,a,s,c,l,u,h,f=["refresh","setItem","getItem","count","sum","key","getUserItem","setUserItem","average","toString","size","length","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],d={_transfer:function(t,e){for(var i=Array.prototype.slice.call(arguments,2),n=i.length-1;n>=0;n--)e[i[n]]=t[i[n]]},average:{fromJsonData:function(t,e){void 0===e.average||void 0===e.average_count?(t.average=-1,t.average_count=0):d._transfer(e,t,"average","average_count")},toJsonData:function(t,e){d._transfer(t,e,"average","average_count")},recompute:function(t,e,i,n){var r=t.average_count;i&&void 0!==i[e.field]&&(t.average=(t.average*r-i[e.field])/parseFloat(r-1),r--),n&&void 0!==n[e.field]&&(t.average=(t.average*r+n[e.field])/parseFloat(r+1),r++),t.average_count=r}},count:{fromJsonData:function(t,e){void 0===e.count?t.count=0:d._transfer(e,t,"count")},toJsonData:function(t,e){d._transfer(t,e,"count")},recompute:function(t,e,i,n){i&&i[e.field]&&void 0!==i[e.field]&&(t.count=t.count-1),n&&n[e.field]&&void 0!==n[e.field]&&t.count++}},sum:{fromJsonData:function(t,e){void 0===e.sum?t.sum=0:d._transfer(e,t,"sum")},toJsonData:function(t,e){d._transfer(t,e,"sum")},recompute:function(t,e,i,n){i&&i[e.field]&&void 0!==i[e.field]&&(t.sum=t.sum-i[e.field]),n&&n[e.field]&&void 0!==n[e.field]&&(t.sum=t.sum+n[e.field])}}},p=function(t,e){if(o.operations)for(var i=0;o.operations.length>i;i++){var n=o.operations[i];(e&&void 0!==e[n.field]||t&&void 0!==t[n.field])&&d[n.operation].recompute(s[n.field],n,t,e)}},v=function(t,e){if(e&&e.marshall)return e;if(e&&"object"==typeof e&&e.constructor!=={}.constructor)throw Error("Unserialisable object");if(("object"!=typeof e||Array.isArray&&Array.isArray(e))&&(e={_type:"literal",value:e}),!e)return null;sanitizedItem={_key:t};var i;if(o.definition&&(i=o.definition.fields)&&i.length>0)for(var n=0;i.length>n;n++){var r=i[n];if(e[r.name]!==void 0)if("string"==r.type)sanitizedItem[r.name]=e[r.name];else if("number"==r.type){var a=parseFloat(e[r.name]);if(isNaN(a)||!isFinite(e[r.name]))throw Error("TypeError","Wrong value for field note");sanitizedItem[r.name]=a}else{if("boolean"!=r.type)throw Error("TypeError","Unkown type "+r.type);sanitizedItem[r.name]=!!e[r.name]}}else sanitizedItem=e,sanitizedItem._key=t;return sanitizedItem},m=function(t){if(!t.data)throw Error("ArgumentError","missing data");if(!t.data.name)throw Error("ArgumentError","no name in data");if(void 0===t.data.count)throw Error("ArgumentError","no count in data");if(s={},c=[],l=[],u=[],n=t.currentUserId,r=t.delegate,o=t.data,this.name=o.name,h=o.count,o.operations)for(var e=0;o.operations.length>e;e++){var i=o.operations[e];s[i.field]=s[i.field]||{},d[i.operation].fromJsonData(s[i.field],i)}g.call(this,o.items)},g=function(t){if(a={},t){for(var e=0;t.length>e;e++){var i=t[e],n=i._key;a[n]=i,y.call(this,n,i),c.push(n)}this.length=c.length}},y=function(t){-1==u.indexOf(t)&&-1==f.indexOf(t)&&(u.push(t),this.__defineGetter__(t,function(){return i.call(this,t)}),this.__defineSetter__(t,function(i){return e.call(this,t,i)}))},x=function(){for(var t=Object.keys(this),i=t.length-1;i>=0;i--){var n=t[i];-1==f.indexOf(n)&&-1==u.indexOf(n)&&(e.call(this,n,this[n]),y.call(this,n,this[n]))}};m.call(this,t)};var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{get:e,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(t,e){Object.defineProperty(this,t,{set:e,enumerable:!0,configurable:!0})}}))}catch(t){throw Error("Simple Storage API not Supported")}};supportGetSet(),UT.CollectionStore=function(t){this.data=t.data;var e=t.delegate;e.store=this;for(var i={},n=0;this.data.length>n;n++){var r=this.data[n],o=r.name;if(!o)throw Error("ArgumentError","data contains unamed collections.");i[o]=new UT.Collection({data:r,postMessageApi:t.postMessageApi,currentUserId:t.currentUserId,delegate:e})}this.get=function(t){return i[t]},this.set=function(t){i[t.name]=t},this.each=function(t){for(var e in i)t(i[e])},this.flush=function(){e.flush()},this.getCurrentData=function(){r=[];for(var t in i)r.push(i[t].getCurrentData());return r},this.refresh=function(t,i){e.refreshCollections(t,i)}};