var UT={},WD=UT;UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},UT.UUID=UT.uuid,UT.Collection=function(e){this.length=0,this.name=null,this.setUserItem=function(e){if(!r)throw i.authenticate(),"ArgumentError: no currentUserId defined";return this.setItem(r,e)},this.getUserItem=function(e){if(!r)return;return this.getItem(r)};var t=function(e,t){if(!e)throw"invalid key: "+e;if(h.indexOf(e)!=-1)throw"reserved key: "+e;var n=v(e,t),r=null;return e&&(r=this.getItem(e)),d(r,n),!r||n!==null&&typeof n!="undefined"?!r&&n?(c++,a.push(e),o[e]=n):o[e]=n:(a.splice(a.indexOf(e),1),c--,delete o[e]),t&&(t._key=e),f.indexOf(e)==-1&&f.push(e),this.length=a.length,t};this.setItem=t;var n=function(e,t){if(!e)return null;var n=o[e];return n===undefined?l.indexOf(e)===-1&&this[e]!==undefined?this[e]:t:n._type=="literal"?n.value:n};this.getItem=n,this.key=function(e){return e>=a.length?null:a[e]},this.average=function(e){if(!u[e])return;return u[e].average},this.sum=function(e){if(!u[e])return;return u[e].sum},this.count=function(e){if(!e)return c;if(!u[e])return;if(u[e])return u[e].count},this.toString=function(){return'<Collection @name="'+this.name+'">'},this.save=function(){b.apply(this);var e={};if(f.length>0){for(var t=0;t<f.length;t++)e[f[t]]=o[f[t]];i.save(this.name,e),f=[]}},this.getCurrentData=function(){var e={name:this.name,count:c,definition:s.definition,operations:[],items:[]};if(s.operations)for(var t=0;t<s.operations.length;t++){var n={operation:s.operations[t].operation,field:s.operations[t].field};p[n.operation].toJsonData(u[n.field],n),e.operations.push(n)}for(var r in o){var i=o[r];i._key=r,e.items.push(i)}return e},this.refresh=function(e){m.call(this,{currentUserId:r,delegate:i,data:e})};var r,i,s,o,u,a,f,l,c,h=["refresh","setItem","getItem","count","sum","key","getUserItem","setUserItem","average","toString","size","length","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],p={_transfer:function(e,t){var n=Array.prototype.slice.call(arguments,2);for(var r=n.length-1;r>=0;r--)t[n[r]]=e[n[r]]},average:{fromJsonData:function(e,t){t.average===undefined||t.average_count===undefined?(e.average=-1,e.average_count=0):p._transfer(t,e,"average","average_count")},toJsonData:function(e,t){p._transfer(e,t,"average","average_count")},recompute:function(e,t,n,r){var i=e.average_count;n&&n[t.field]!==undefined&&(e.average=(e.average*i-n[t.field])/parseFloat(i-1),i--),r&&r[t.field]!==undefined&&(e.average=(e.average*i+r[t.field])/parseFloat(i+1),i++),e.average_count=i}},count:{fromJsonData:function(e,t){t.count===undefined?e.count=0:p._transfer(t,e,"count")},toJsonData:function(e,t){p._transfer(e,t,"count")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==undefined&&(e.count=e.count-1),r&&r[t.field]&&r[t.field]!==undefined&&e.count++}},sum:{fromJsonData:function(e,t){t.sum===undefined?e.sum=0:p._transfer(t,e,"sum")},toJsonData:function(e,t){p._transfer(e,t,"sum")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==undefined&&(e.sum=e.sum-n[t.field]),r&&r[t.field]&&r[t.field]!==undefined&&(e.sum=e.sum+r[t.field])}}},d=function(e,t){if(s.operations)for(var n=0;n<s.operations.length;n++){var r=s.operations[n];(t&&t[r.field]!==undefined||e&&e[r.field]!==undefined)&&p[r.operation].recompute(u[r.field],r,e,t)}},v=function(e,t){if(typeof t!="object"||Array.isArray&&Array.isArray(t))t={_type:"literal",value:t};if(!t)return null;sanitizedItem={_key:e};var n;if(s.definition&&(n=s.definition.fields)&&n.length>0)for(var r=0;r<n.length;r++){var i=n[r];if(typeof t[i.name]!="undefined")if(i.type=="string")sanitizedItem[i.name]=t[i.name];else if(i.type=="number"){var o=parseFloat(t[i.name]);if(!!isNaN(o)||!isFinite(t[i.name]))throw"TypeError: wrong value for field note";sanitizedItem[i.name]=o}else{if(i.type!="boolean")throw"TypeError: Unkown type "+i.type;sanitizedItem[i.name]=!!t[i.name]}}else sanitizedItem=t,sanitizedItem._key=e;return sanitizedItem},m=function(e){if(!e.data)throw"ArgumentError: missing data";if(!e.data.name)throw"ArgumentError: no name in data";if(e.data.count===undefined)throw"ArgumentError: no count in data";u={},a=[],f=[],l=[],r=e.currentUserId,i=e.delegate,s=e.data,this.name=s.name,c=s.count;if(s.operations)for(var t=0;t<s.operations.length;t++){var n=s.operations[t];u[n.field]=u[n.field]||{},p[n.operation].fromJsonData(u[n.field],n)}g.call(this,s.items)},g=function(e){o={};if(!e)return;for(var t=0;t<e.length;t++){var n=e[t],r=n._key;o[r]=n,y.call(this,r,n),a.push(r)}this.length=a.length},y=function(e,r){l.indexOf(e)==-1&&h.indexOf(e)==-1&&(l.push(e),this.__defineGetter__(e,function(){return n.call(this,e)}),this.__defineSetter__(e,function(n){return t.call(this,e,n)}))},b=function(){var e=Object.keys(this);for(var n=e.length-1;n>=0;n--){var r=e[n];h.indexOf(r)==-1&&l.indexOf(r)==-1&&(t.call(this,r,this[r]),y.call(this,r,this[r]))}};m.call(this,e)};var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{get:t,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{set:t,enumerable:!0,configurable:!0})}}))}catch(e){throw"Simple Storage API not Supported"}};supportGetSet(),UT.CollectionStore=function(e){this.data=e.data;var t=e.delegate;t.store=this;var n={};for(var r=0;r<this.data.length;r++){var i=this.data[r],s=i.name;if(!s)throw"ArgumentError: data contains unamed collections.";n[s]=new UT.Collection({data:i,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t})}this.get=function(e){return n[e]},this.set=function(e){n[e.name]=e},this.flush=function(e){t.flush()},this.getCurrentData=function(){i=[];for(var e in n)i.push(n[e].getCurrentData());return i},this.refresh=function(e,n){t.refreshCollections(e,n)}};