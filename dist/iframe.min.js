var UT={},WD=UT;UT.Expression=function(){function a(e,t){s=null,o.push({name:e,module:t})}function f(e){this._getInstance().bind("ready",e),s.isReady&&e.apply(this,[s]);if("ontouchstart"in window||"onmsgesturechange"in window)document.querySelector("body").className=document.querySelector("body").className+" touch";return s}function l(e,t,n){var r={type:"ExpAPICall",methodName:e,args:t,expToken:i?i.expToken:null};if(n){var s=(new UT.UUID).toString();u[s]=n,r.callbackId=s}window.parent.postMessage(JSON.stringify(r),"*")}function c(){return s=s||h({}),s}function h(t){function a(t){var n=s[t],r=[],i="after"+t.charAt(0).toUpperCase()+t.slice(1),o,u,f,l,c;if(!n)return;n=n.slice(0),o=n.length,u=-1,l=Array.prototype.slice.call(arguments,1);while(++u<o)f=n[u],c=f.apply(e,l),c&&typeof c.then=="function"&&r.push(c);r.length>0?when.all(r).then(function(){a(i)}):a(i)}function f(e,t){var n=s[e]||(s[e]=[]);if(typeof t!="function")return;n.push(t)}function l(e,t){var n=s[e],r;if(!n)return;if(!t){delete s[e];return}r=n?n.indexOf(t):-1;while(r!==-1)n.splice(r,1),r=n.indexOf(t)}function c(e){n=e}function h(e){typeof e=="string"?(i.note=e,UT.Expression._callAPI("document.setNote",[e],function(){})):console.error("note should be a string (expression.setNote)")}function p(e){UT.Expression._callAPI("document.readyToPost",[e],function(){})}function d(){return i.note}function v(e){f("modeChanged",e)}function m(e){f("scrollChanged",e)}function g(e){f("imageAdded",e)}function y(){return i.mode}function b(){return i.scrollValues}function w(e){if(!i||!i[e])return;return i[e]}function E(){return document.querySelector(".webdoc_expression_wrapper")}function S(){for(var e in o){var n=o[e];if(t[n.name])throw"Extension "+n.name+" is already defined.";typeof n.module=="function"?t[n.name]=n.module.call(UT,t):t[n.name]=n.module}}function x(e,t,n){UT.Expression._callAPI("document.textInput",[e,t],n)}function T(e,t,n){n===undefined&&typeof t=="function"&&(n=t,t={});switch(e){case"sound":UT.Expression._callAPI("medias.openSoundChooser",[t],n);break;case"image":t&&t.size&&t.size.auto&&console.warn("Use of size.auto is deprecated, use size.autoCrop instead"),UT.Expression._callAPI("medias.openImageChooser",[t],function(e){n.call(this,e)});break;case"video":UT.Expression._callAPI("medias.openVideoChooser",[t],n)}}function N(e){switch(e.type){case"ready":C(e.options);break;case"triggerEvent":a.apply(this,[e.eventName].concat(e.eventArgs));break;case"callback":A(e.callbackId,e.result);break;case"post":k()}}function C(e){t.isReady=!0,i=e,f("modeChanged",function(e){i.mode=e}),f("scrollChanged",function(e){i.scrollValues=e}),f("afterReady",function(){L("initialized")}),S(),a("ready",t)}function k(){n&&n.call(e,function(){}),UT.Expression._callAPI("posted")}function L(e){UT.Expression._callAPI("changeCurrentState",[e])}function A(e,t){var n=u[e];n&&(t&&t instanceof Array||window.console&&console.error&&console.error("received result is not an array.",t),n.apply(this,t),delete u[e])}var r=window.console&&console.log,s={};return window.addEventListener("message",function(e){var t;try{msgObj=JSON.parse(e.data)}catch(n){console&&console.error&&console.error("receive invalid message",e.data,n.message),msgObj={}}N(msgObj)},!1),t.dialog=T,t.textInput=x,t.trigger=a,t.bind=f,t.unbind=l,t.post=c,t.modeChanged=v,t.scrollChanged=m,t.imageAdded=g,t.getMode=y,t.getScrollValues=b,t.getState=w,t.getElement=E,t.initializeExtension=S,t.getNote=d,t.setNote=h,t.readyToPost=p,t}var e,t=!1,n=null,r={},i,s=null,o=[],u={};return e={ready:f,extendExpression:a,_expression:s},e._callAPI=l,e._getInstance=c,e}(),UT.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},UT.Collection=function(e){this.length=0,this.name=null,this.setUserItem=function(e){if(!r)throw i.authenticate(),"ArgumentError: no currentUserId defined";return this.setItem(r,e)},this.getUserItem=function(e){if(!r)return;return this.getItem(r)};var t=function(e,t){if(!e)throw"invalid key: "+e;if(h.indexOf(e)!=-1)throw"reserved key: "+e;var n=v(e,t),r=null;return e&&(r=this.getItem(e)),d(r,n),!r||n!==null&&typeof n!="undefined"?!r&&n?(c++,a.push(e),o[e]=n):o[e]=n:(a.splice(a.indexOf(e),1),c--,delete o[e]),t&&(t._key=e),f.indexOf(e)==-1&&f.push(e),this.length=a.length,t};this.setItem=t;var n=function(e,t){if(!e)return null;var n=o[e];return n===undefined?l.indexOf(e)===-1&&this[e]!==undefined?this[e]:t:n._type=="literal"?n.value:n};this.getItem=n,this.key=function(e){return e>=a.length?null:a[e]},this.average=function(e){if(!u[e])return;return u[e].average},this.sum=function(e){if(!u[e])return;return u[e].sum},this.count=function(e){if(!e)return c;if(!u[e])return;if(u[e])return u[e].count},this.toString=function(){return'<Collection @name="'+this.name+'">'},this.save=function(){b.apply(this);var e={};if(f.length>0){for(var t=0;t<f.length;t++)e[f[t]]=o[f[t]];i.save(this.name,e),f=[]}},this.getCurrentData=function(){var e={name:this.name,count:c,definition:s.definition,operations:[],items:[]};if(s.operations)for(var t=0;t<s.operations.length;t++){var n={operation:s.operations[t].operation,field:s.operations[t].field};p[n.operation].toJsonData(u[n.field],n),e.operations.push(n)}for(var r in o){var i=o[r];i._key=r,e.items.push(i)}return e},this.refresh=function(e){m.call(this,{currentUserId:r,delegate:i,data:e})};var r,i,s,o,u,a,f,l,c,h=["refresh","setItem","getItem","count","sum","key","getUserItem","setUserItem","average","toString","size","length","length","name","save","fieldDefs","sanitizedItem","getCurrentData"],p={_transfer:function(e,t){var n=Array.prototype.slice.call(arguments,2);for(var r=n.length-1;r>=0;r--)t[n[r]]=e[n[r]]},average:{fromJsonData:function(e,t){t.average===undefined||t.average_count===undefined?(e.average=-1,e.average_count=0):p._transfer(t,e,"average","average_count")},toJsonData:function(e,t){p._transfer(e,t,"average","average_count")},recompute:function(e,t,n,r){var i=e.average_count;n&&n[t.field]!==undefined&&(e.average=(e.average*i-n[t.field])/parseFloat(i-1),i--),r&&r[t.field]!==undefined&&(e.average=(e.average*i+r[t.field])/parseFloat(i+1),i++),e.average_count=i}},count:{fromJsonData:function(e,t){t.count===undefined?e.count=0:p._transfer(t,e,"count")},toJsonData:function(e,t){p._transfer(e,t,"count")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==undefined&&(e.count=e.count-1),r&&r[t.field]&&r[t.field]!==undefined&&e.count++}},sum:{fromJsonData:function(e,t){t.sum===undefined?e.sum=0:p._transfer(t,e,"sum")},toJsonData:function(e,t){p._transfer(e,t,"sum")},recompute:function(e,t,n,r){n&&n[t.field]&&n[t.field]!==undefined&&(e.sum=e.sum-n[t.field]),r&&r[t.field]&&r[t.field]!==undefined&&(e.sum=e.sum+r[t.field])}}},d=function(e,t){if(s.operations)for(var n=0;n<s.operations.length;n++){var r=s.operations[n];(t&&t[r.field]!==undefined||e&&e[r.field]!==undefined)&&p[r.operation].recompute(u[r.field],r,e,t)}},v=function(e,t){if(typeof t!="object"||Array.isArray&&Array.isArray(t))t={_type:"literal",value:t};if(!t)return null;sanitizedItem={_key:e};var n;if(s.definition&&(n=s.definition.fields)&&n.length>0)for(var r=0;r<n.length;r++){var i=n[r];if(typeof t[i.name]!="undefined")if(i.type=="string")sanitizedItem[i.name]=t[i.name];else if(i.type=="number"){var o=parseFloat(t[i.name]);if(!!isNaN(o)||!isFinite(t[i.name]))throw"TypeError: wrong value for field note";sanitizedItem[i.name]=o}else{if(i.type!="boolean")throw"TypeError: Unkown type "+i.type;sanitizedItem[i.name]=!!t[i.name]}}else sanitizedItem=t,sanitizedItem._key=e;return sanitizedItem},m=function(e){if(!e.data)throw"ArgumentError: missing data";if(!e.data.name)throw"ArgumentError: no name in data";if(e.data.count===undefined)throw"ArgumentError: no count in data";u={},a=[],f=[],l=[],r=e.currentUserId,i=e.delegate,s=e.data,this.name=s.name,c=s.count;if(s.operations)for(var t=0;t<s.operations.length;t++){var n=s.operations[t];u[n.field]=u[n.field]||{},p[n.operation].fromJsonData(u[n.field],n)}g.call(this,s.items)},g=function(e){o={};if(!e)return;for(var t=0;t<e.length;t++){var n=e[t],r=n._key;o[r]=n,y.call(this,r,n),a.push(r)}this.length=a.length},y=function(e,r){l.indexOf(e)==-1&&h.indexOf(e)==-1&&(l.push(e),this.__defineGetter__(e,function(){return n.call(this,e)}),this.__defineSetter__(e,function(n){return t.call(this,e,n)}))},b=function(){var e=Object.keys(this);for(var n=e.length-1;n>=0;n--){var r=e[n];h.indexOf(r)==-1&&l.indexOf(r)==-1&&(t.call(this,r,this[r]),y.call(this,r,this[r]))}};m.call(this,e)};var supportGetSet=function(){try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{get:t,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(e,t){Object.defineProperty(this,e,{set:t,enumerable:!0,configurable:!0})}}))}catch(e){throw"Simple Storage API not Supported"}};supportGetSet(),UT.CollectionStore=function(e){this.data=e.data;var t=e.delegate;t.store=this;var n={};for(var r=0;r<this.data.length;r++){var i=this.data[r].name;if(!i)throw"ArgumentError: data contains unamed collections.";(function(r){n[i]=new UT.Collection({data:r,postMessageApi:e.postMessageApi,currentUserId:e.currentUserId,delegate:t})})(this.data[r])}this.get=function(e){return n[e]},this.set=function(e){n[e.name]=e},this.flush=function(e){t.flush()},this.getCurrentData=function(){data=[];for(var e in n)data.push(n[e].getCurrentData());return data},this.refresh=function(e,n){t.refreshCollections(e,n)}},UT.Expression.extendExpression("container",function(e){var t={};return t.autoResize=function(){var t=e.getElement().scrollHeight;UT.Expression._callAPI("container.resizeHeight",[t])},t.resizeHeight=function(e,t){UT.Expression._callAPI("container.resizeHeight",[e],t)},t.setTitle=function(e){UT.Expression._callAPI("container.setTitle",[e])},popupUsers=function(e){UT.Expression._callAPI("container.popupUsers",[uerIds])},popup=function(e,t){UT.Expression._callAPI("container.popup",[e,t])},closePopup=function(){UT.Expression._callAPI("container.closePopup")},t}),UT.Expression.extendExpression("medias",function(e){return{imageDialog:function(e,t){console&&console.warn&&console.warn("Usage of imageDialog Deprecated, use expression.dialog instead"),t||(t=e,e={}),e&&e.size&&e.size.auto&&window.console&&console.warn&&console.warn("Use of size.auto is deprecated, use size.autoCrop instead"),UT.Expression._callAPI("medias.openImageChooser",[e],function(e){t.call(this,e)})},createImage:function(t,n){var r=e.readyToPost();e.readyToPost(),UT.Expression._callAPI("medias.createImage",[t],function(){e.readyToPost(r),n.apply(e,arguments)})},reCrop:function(e,t,n){e._type&&e._type==="image"?e._original?UT.Expression._callAPI("medias.reCrop",[{url:e._original,crop:t}],n):UT.Expression._callAPI("medias.reCrop",[{url:e.url,crop:t}],n):UT.Expression._callAPI("medias.reCrop",[{url:e,crop:t}],n)},crop:function(e,t,n){var r=0;e.pictureID&&(r=e.pictureID),e._original?e=e._original:e.url&&(e=e.url),UT.Expression._callAPI("medias.crop",[{pictureID:r,url:e,size:t}],function(e){n.call(this,e)})},applyFilterToImage:function(e,t,n){var r=null;e._center&&(r=e._center),e._type&&e._type==="image"?e._original?UT.Expression._callAPI("medias.applyFilter",[{url:e._original,filter:t,crop:r}],n):UT.Expression._callAPI("medias.applyFilter",[{url:e.url,filter:t,crop:r}],n):UT.Expression._callAPI("medias.applyFilter",[{url:e,filter:t}],n)},saveImage:function(e,t,n){UT.Expression._callAPI("medias.createImage",[t],function(t,r){postMessageAPI.apply("items.save",[e,t],function(r,i){if(i){!n&&window.console&&console.error?console.error("Unable to save object with key: "+e,i.message):n&&n.call(i,null,i);return}t._id=r._id,n&&n.call(t,t,null)})})},imageWithDataUrl:function(e,t){UT.Expression._callAPI("medias.imageWithDataUrl",[e],t)},soundDialog:function(e,t){console&&console.warn&&console.warn("Usage of soundDialog Deprecated, use expression.dialog instead"),UT.Expression._callAPI("medias.openSoundChooser",[e],t)},videoDialog:function(e,t){console&&console.warn&&console.warn("Usage of videoDialog Deprecated, use expression.dialog instead"),UT.Expression._callAPI("medias.openVideoChooser",[e],t)},findImage:function(e,t){UT.Expression._callAPI("medias.findImage",[e],t)}}}),UT.Expression.extendExpression("document",function(e){return{getDocumentURL:function(){return e.getState("documentURL")},getDocumentPrivacy:function(){return e.getState("documentPrivacy")}}}),UT.Expression.extendExpression("url",function(e){var t={};return t.for=function(e){return t.getAssetPath(e)},t.getAssetThroughProxy=function(e){return this.proxify(this.getAssetPath(e))},t.getAssetPath=function(t){return t.indexOf("./")===0&&(t=t.substring(1)),e.getState("assetPath").indexOf("http")===-1?"http://"+e.getState("host")+"/"+e.getState("assetPath")+t:e.getState("assetPath")+t},t.proxify=function(t){var n="http://"+e.getState("host")+"/image_proxy/";if(typeof t=="string"&&t.indexOf("data:image")!=0&&t.indexOf("image_proxy")==-1){var r=t;return t.indexOf("http://")==0?r=n+t.substring(7):t.indexOf("https://")==0?r=n+t.substring(8):r=n+t,r}return t},t}),UT.Expression.extendExpression("collections",function(e){var t=e.getState("documentId"),n=e.getState("collections"),r=e.getState("currentUserId");if(t&&n){var i=new UT.CollectionStore({data:n,currentUserId:r,delegate:{save:function(e,t,n){UT.Expression._callAPI("collections.save",[e,t],n)},authenticate:function(e){UT.Expression._callAPI("authenticate")}}});return e.storage=i.get("default"),i}});